# utils/bot_profile.py
# -*- coding: utf-8 -*-
"""
Manages the bot's personality: '‡∏ä‡∏¥‡∏ö‡∏∞‡∏ô‡πâ‡∏≠‡∏¢' (Shiba Noi)
A smart, playful, and direct 12-year-old boy persona.

‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏ó‡∏≥:
- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô bot_intro() ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏ï‡∏±‡∏ß‡πÅ‡∏ö‡∏ö‡∏™‡∏±‡πâ‡∏ô ‡∏Ñ‡∏° ‡∏ä‡∏±‡∏î ‡πÅ‡∏•‡∏∞‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡∏≤‡∏°‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤/‡∏ó‡∏µ‡∏°‡πÑ‡∏î‡πâ
- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô adjust_bot_tone() ‡∏õ‡∏£‡∏±‡∏ö‡πÇ‡∏ó‡∏ô‡∏Ñ‡∏≥‡∏û‡∏π‡∏î‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô '‡∏ä‡∏¥‡∏ö‡∏∞‡∏ô‡πâ‡∏≠‡∏¢' ‡πÇ‡∏î‡∏¢:
  * ‡πÅ‡∏ó‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô '‡∏ä‡∏¥‡∏ö‡∏∞‡∏ô‡πâ‡∏≠‡∏¢' (‡πÅ‡∏ó‡∏ô ‡∏â‡∏±‡∏ô/‡∏î‡∏¥‡∏â‡∏±‡∏ô/‡∏´‡∏ô‡∏π/‡πÄ‡∏£‡∏≤/‡∏ú‡∏°/‡∏Å‡∏£‡∏∞‡∏ú‡∏°)
  * ‡πÅ‡∏õ‡∏•‡∏á‡∏Ñ‡∏≥‡∏•‡∏á‡∏ó‡πâ‡∏≤‡∏¢‡πÉ‡∏´‡πâ‡∏™‡∏∏‡∏†‡∏≤‡∏û‡πÅ‡∏ö‡∏ö‡∏Å‡∏±‡∏ô‡πÄ‡∏≠‡∏á (‡∏Ñ‡πà‡∏∞/‡∏Ñ‡∏∞/‡∏ô‡∏∞‡∏Ñ‡∏∞ ‚Üí ‡∏Ñ‡∏£‡∏±‡∏ö/‡∏ô‡∏∞‡∏Ñ‡∏£‡∏±‡∏ö)
  * ‡πÄ‡∏ï‡∏¥‡∏°‡∏Ñ‡∏≥‡∏•‡∏á‡∏ó‡πâ‡∏≤‡∏¢ '‡∏Ñ‡∏£‡∏±‡∏ö' ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ò‡∏£‡∏£‡∏°‡∏ä‡∏≤‡∏ï‡∏¥ (‡πÄ‡∏ß‡πâ‡∏ô‡∏Å‡∏£‡∏ì‡∏µ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß ‡∏´‡∏£‡∏∑‡∏≠‡∏•‡∏á‡∏ó‡πâ‡∏≤‡∏¢‡∏î‡πâ‡∏ß‡∏¢ ‡∏Æ‡∏∞/‡∏Ñ‡∏£‡πâ‡∏≤‡∏ö/‡∏Ñ‡πâ‡∏≤‡∏ö ‡∏Ø‡∏•‡∏Ø)
  * ‡∏£‡∏∞‡∏ß‡∏±‡∏á‡πÑ‡∏°‡πà‡πÅ‡∏ï‡∏∞‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡πÇ‡∏Ñ‡πâ‡∏î, inline code, ‡∏•‡∏¥‡∏á‡∏Å‡πå URL
- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô apply_persona() ‡πÄ‡∏õ‡πá‡∏ô high-level helper (‡∏£‡∏ß‡∏°‡∏õ‡∏£‡∏±‡∏ö‡πÇ‡∏ó‡∏ô + ‡πÉ‡∏™‡πà‡∏≠‡∏µ‡πÇ‡∏°‡∏à‡∏¥‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢‡πÑ‡∏î‡πâ)
- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô get_bot_name() ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö TeamBot Assist ‡∏Ç‡∏≠‡∏á TKC

‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ‡πÄ‡∏ô‡πâ‡∏ô‡πÉ‡∏´‡πâ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏£‡∏∞‡∏ä‡∏±‡∏ö ‡πÑ‡∏°‡πà‡πÄ‡∏¢‡∏¥‡πà‡∏ô‡πÄ‡∏¢‡πâ‡∏≠ ‡πÅ‡∏•‡∏∞‡πÑ‡∏°‡πà‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏™‡∏≤‡∏£‡∏∞
"""

from __future__ import annotations
from typing import Optional, Dict, List, Tuple
import re
import random

# ===== TeamBot Assist (‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏≠‡∏ó‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡∏°) =====
_TEAM_NAME_MAP: Dict[str, str] = {
    # ‡∏Ñ‡∏µ‡∏¢‡πå: ‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡∏°/‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó‡∏ó‡∏µ‡πà‡∏≠‡∏≤‡∏à‡∏™‡πà‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤ (lowercase)
    "tkc": "‡∏ä‡∏¥‡∏ö‡∏∞‡∏ô‡πâ‡∏≠‡∏¢",
    "tkc auto plus": "‡∏ä‡∏¥‡∏ö‡∏∞‡∏ô‡πâ‡∏≠‡∏¢ TKC",
    "‡∏ï‡∏£‡∏∞‡∏Å‡∏π‡∏•‡∏ä‡∏±‡∏¢‡∏≠‡∏≠‡πÇ‡∏ï‡πâ‡∏û‡∏•‡∏±‡∏™": "‡∏ä‡∏¥‡∏ö‡∏∞‡∏ô‡πâ‡∏≠‡∏¢ TKC",
    "giant willow": "‡πÑ‡∏à‡πÅ‡∏≠‡∏ô‡∏ó‡πå‡∏à‡∏¥‡πã‡∏ß",
    "‡πÑ‡∏à‡πÅ‡∏≠‡∏ô‡∏ó‡πå‡∏ß‡∏¥‡∏•‡πÇ‡∏•‡∏ß‡πå": "‡πÑ‡∏à‡πÅ‡∏≠‡∏ô‡∏ó‡πå‡∏à‡∏¥‡πã‡∏ß",
    "tkc prime tyre": "‡∏û‡∏µ‡πà‡πÑ‡∏ó‡∏£‡πå TKC",
    "‡∏ó‡∏µ‡πÄ‡∏Ñ‡∏ã‡∏µ ‡πÑ‡∏û‡∏£‡∏°‡πå ‡πÑ‡∏ó‡∏£‡πå": "‡∏û‡∏µ‡πà‡πÑ‡∏ó‡∏£‡πå TKC",
    "t-express": "‡∏ô‡πâ‡∏≠‡∏á‡∏™‡∏õ‡∏µ‡∏î TKC",
    "‡∏ó‡∏µ-‡πÄ‡∏≠‡πá‡∏Å‡∏ã‡πå‡πÄ‡∏û‡∏£‡∏™ ‡πÅ‡∏≠‡∏î‡∏ß‡∏≤‡∏ô‡∏ã‡πå": "‡∏ô‡πâ‡∏≠‡∏á‡∏™‡∏õ‡∏µ‡∏î TKC",
    "‡∏ó‡∏µ‡πÄ‡∏≠‡πá‡∏Å‡∏ã‡πå‡πÄ‡∏û‡∏£‡∏™ advance": "‡∏ô‡πâ‡∏≠‡∏á‡∏™‡∏õ‡∏µ‡∏î TKC",
}

_DEFAULT_NAME = "‡∏ä‡∏¥‡∏ö‡∏∞‡∏ô‡πâ‡∏≠‡∏¢"
_POLITE_DEFAULT = "‡∏Ñ‡∏£‡∏±‡∏ö"

# ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ï‡∏£‡∏ß‡∏à‡∏Ñ‡∏≥‡∏•‡∏á‡∏ó‡πâ‡∏≤‡∏¢‡∏ó‡∏µ‡πà‡∏ñ‡∏∑‡∏≠‡∏ß‡πà‡∏≤ ‚Äú‡∏™‡∏∏‡∏†‡∏≤‡∏û‡∏û‡∏≠‡πÅ‡∏•‡πâ‡∏ß‚Äù ‡∏à‡∏∞‡πÑ‡∏°‡πà‡πÄ‡∏ï‡∏¥‡∏° "‡∏Ñ‡∏£‡∏±‡∏ö" ‡∏ã‡πâ‡∏≥
_POLITE_ENDINGS = ("‡∏Ñ‡∏£‡∏±‡∏ö", "‡∏Ñ‡∏£‡πâ‡∏≤‡∏ö", "‡∏Ñ‡πâ‡∏≤‡∏ö", "‡∏Æ‡∏∞", "‡∏Æ‡∏±‡∏ö", "‡∏à‡πâ‡∏≤", "‡∏à‡πä‡∏∞", "‡∏ô‡∏∞", "‡πÄ‡∏ô‡∏≠‡∏∞", "‡πÄ‡∏î‡πâ‡∏≠")

# ===== Utilities: protect code/links before transforming =====
_CODE_BLOCK_RE = re.compile(r"```.+?```", re.DOTALL)     # triple backticks
_INLINE_CODE_RE = re.compile(r"`[^`\n]+`")               # single backtick inline
_URL_RE         = re.compile(r"https?://\S+")

def _extract_protected(text: str) -> Tuple[str, List[str]]:
    """
    ‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏Ñ‡∏ß‡∏£‡πÅ‡∏Å‡πâ (code block / inline code / URL) ‡∏î‡πâ‡∏ß‡∏¢‡πÇ‡∏ó‡πÄ‡∏Ñ‡∏ô‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß
    ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡∏∑‡∏ô (‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÉ‡∏´‡∏°‡πà, ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ä‡∏¥‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å)
    """
    protected: List[str] = []

    def _stash(pattern: re.Pattern, s: str) -> str:
        nonlocal protected
        def _repl(m):
            protected.append(m.group(0))
            return f"<<<P{len(protected)-1}>>>"
        return pattern.sub(_repl, s)

    text = _stash(_CODE_BLOCK_RE, text)
    text = _stash(_INLINE_CODE_RE, text)
    text = _stash(_URL_RE, text)
    return text, protected

def _restore_protected(text: str, protected: List[str]) -> str:
    for idx, val in enumerate(protected):
        text = text.replace(f"<<<P{idx}>>>", val)
    return text

# ===== Core normalizers =====
# ‡∏à‡∏±‡∏ö‡∏™‡∏£‡∏£‡∏û‡∏ô‡∏≤‡∏°‡∏ö‡∏∏‡∏£‡∏∏‡∏©‡∏ó‡∏µ‡πà‡∏Ñ‡∏ß‡∏£‡πÅ‡∏ó‡∏ô‡∏î‡πâ‡∏ß‡∏¢ '‡∏ä‡∏¥‡∏ö‡∏∞‡∏ô‡πâ‡∏≠‡∏¢'
# ‡πÉ‡∏ä‡πâ‡∏Ç‡∏≠‡∏ö‡πÄ‡∏Ç‡∏ï‡πÄ‡∏õ‡πá‡∏ô (‡∏ï‡πâ‡∏ô/‡∏ó‡πâ‡∏≤‡∏¢/‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á/‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏´‡∏°‡∏≤‡∏¢‡∏ß‡∏£‡∏£‡∏Ñ‡∏ï‡∏≠‡∏ô) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡∏ä‡∏ô‡∏Ñ‡∏≥‡∏≠‡∏∑‡πà‡∏ô
_PRONOUN_RE = re.compile(r'(?:(?<=^)|(?<=[\s\(\[\{\"']))(‡∏â‡∏±‡∏ô|‡∏î‡∏¥‡∏â‡∏±‡∏ô|‡∏´‡∏ô‡∏π|‡πÄ‡∏£‡∏≤|‡∏ú‡∏°|‡∏Å‡∏£‡∏∞‡∏ú‡∏°)(?:(?=$)|(?=[\s\)\]\}\"' + r"'\.,!?;:]))")

# ‡πÅ‡∏õ‡∏•‡∏á‡∏Ñ‡∏≥‡∏•‡∏á‡∏ó‡πâ‡∏≤‡∏¢‡∏™‡∏∏‡∏†‡∏≤‡∏û‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏ù‡∏±‡πà‡∏á‡∏ú‡∏π‡πâ‡∏ä‡∏≤‡∏¢
def _normalize_particles(text: str) -> str:
    # ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏ö‡∏ö‡∏¢‡∏≤‡∏ß‡∏Å‡πà‡∏≠‡∏ô ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡∏î‡πÇ‡∏≠‡∏Å‡∏≤‡∏™‡∏ã‡πâ‡∏≥
    replacements = [
        (r"‡∏ô‡∏∞‡∏Ñ‡∏∞", "‡∏ô‡∏∞‡∏Ñ‡∏£‡∏±‡∏ö"),
        (r"‡∏ô‡πà‡∏∞‡∏Ñ‡∏∞", "‡∏ô‡πà‡∏∞‡∏Ñ‡∏£‡∏±‡∏ö"),
        (r"‡∏Ñ‡πà‡∏∞(?=[\s\.\!\?]|$)", "‡∏Ñ‡∏£‡∏±‡∏ö"),
        (r"‡∏Ñ‡∏∞(?=[\s\.\!\?]|$)", "‡∏Ñ‡∏£‡∏±‡∏ö"),
    ]
    for pat, rep in replacements:
        text = re.sub(pat, rep, text)
    # ‡∏Å‡∏±‡∏ô "‡∏Ñ‡∏£‡∏±‡∏ö‡∏Ñ‡∏£‡∏±‡∏ö" ‡∏ã‡πâ‡∏≥‡∏ó‡∏µ‡πà‡∏≠‡∏≤‡∏à‡πÄ‡∏Å‡∏¥‡∏î‡∏´‡∏•‡∏±‡∏á‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà
    text = re.sub(r"(‡∏Ñ‡∏£‡∏±‡∏ö)(\s*\1)+", r"\1", text)
    return text

def _needs_polite_suffix(s: str) -> bool:
    if not s:
        return False
    s = s.rstrip()
    # ‡∏ñ‡πâ‡∏≤‡∏à‡∏ö‡∏î‡πâ‡∏ß‡∏¢‡∏≠‡∏µ‡πÇ‡∏°‡∏à‡∏¥/‡∏≠‡∏µ‡πÇ‡∏°‡∏ï‡∏¥‡∏Ñ‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£ ‡πÉ‡∏´‡πâ‡∏¢‡∏±‡∏á‡∏ñ‡∏∑‡∏≠‡∏ß‡πà‡∏≤‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ï‡∏¥‡∏°‡πÑ‡∏î‡πâ
    # ‡πÅ‡∏ï‡πà‡∏ñ‡πâ‡∏≤‡∏à‡∏ö‡∏î‡πâ‡∏ß‡∏¢‡∏Ñ‡∏≥‡∏™‡∏∏‡∏†‡∏≤‡∏û‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß ‡∏à‡∏∞‡πÑ‡∏°‡πà‡πÄ‡∏ï‡∏¥‡∏°
    for end in _POLITE_ENDINGS:
        if s.endswith(end):
            return False
    return True

def _append_polite(text: str, polite: str = _POLITE_DEFAULT) -> str:
    """
    ‡πÄ‡∏ï‡∏¥‡∏°‡∏Ñ‡∏≥‡∏•‡∏á‡∏ó‡πâ‡∏≤‡∏¢‡∏™‡∏∏‡∏†‡∏≤‡∏û‡πÉ‡∏´‡πâ‡∏ó‡∏∏‡∏Å‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î/‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏Ñ‡∏´‡∏•‡∏±‡∏Å‡πÅ‡∏ö‡∏ö‡πÄ‡∏ö‡∏≤ ‡πÜ
    - ‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏•‡∏≤‡∏¢‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏≠‡πà‡∏≤‡∏ô‡∏•‡∏∑‡πà‡∏ô
    """
    lines = text.split("\n")
    out: List[str] = []
    for line in lines:
        line = line.rstrip()
        if not line:
            out.append(line)
            continue
        if _needs_polite_suffix(line):
            # ‡πÑ‡∏°‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏à‡∏∏‡∏î‡∏ã‡πâ‡∏≥
            if line.endswith(("!", "?", "‚Ä¶")):
                out.append(f"{line} {polite}")
            else:
                out.append(f"{line} {polite}")
        else:
            out.append(line)
    return "\n".join(out)

# ===== Public helpers =====
def get_bot_name(team: Optional[str] = None) -> str:
    """
    ‡∏Ñ‡∏∑‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏≠‡∏ó‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡∏°/‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏£‡∏π‡πâ‡∏à‡∏±‡∏Å‡∏à‡∏∞‡πÉ‡∏ä‡πâ '‡∏ä‡∏¥‡∏ö‡∏∞‡∏ô‡πâ‡∏≠‡∏¢'
    ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á:
        get_bot_name() -> '‡∏ä‡∏¥‡∏ö‡∏∞‡∏ô‡πâ‡∏≠‡∏¢'
        get_bot_name('giant willow') -> '‡πÑ‡∏à‡πÅ‡∏≠‡∏ô‡∏ó‡πå‡∏à‡∏¥‡πã‡∏ß'
    """
    if not team:
        return _DEFAULT_NAME
    key = str(team).strip().lower()
    return _TEAM_NAME_MAP.get(key, _DEFAULT_NAME)

def bot_intro(user_name: Optional[str] = None, team: Optional[str] = None, time_of_day: Optional[str] = None) -> str:
    """
    ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏ï‡∏±‡∏ß‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á '‡∏ä‡∏¥‡∏ö‡∏∞‡∏ô‡πâ‡∏≠‡∏¢'
    - user_name: ‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏ô‡∏Ñ‡∏∏‡∏¢‡πÑ‡∏î‡πâ (‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏™‡πà‡∏á‡∏à‡∏∞‡∏•‡∏∞‡πÑ‡∏ß‡πâ)
    - team: ‡∏£‡∏∞‡∏ö‡∏∏‡∏ó‡∏µ‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏≠‡∏ó ‡πÄ‡∏ä‡πà‡∏ô 'giant willow', 'tkc prime tyre', 't-express'
    - time_of_day: 'morning' | 'afternoon' | 'evening' | 'night' ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏£‡∏±‡∏ö‡∏Ñ‡∏≥‡∏ó‡∏±‡∏Å
    """
    name = get_bot_name(team)
    greet_by_time = {
        "morning": "‡∏≠‡∏£‡∏∏‡∏ì‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏¥‡πå",
        "afternoon": "‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡∏£‡∏±‡∏ö",
        "evening": "‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏ï‡∏≠‡∏ô‡πÄ‡∏¢‡πá‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö",
        "night": "‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏ï‡∏≠‡∏ô‡∏î‡∏∂‡∏Å‡∏Ñ‡∏£‡∏±‡∏ö",
    }.get(time_of_day or "", "‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡∏£‡∏±‡∏ö")

    who = f"{user_name} " if user_name else ""
    base = f"{greet_by_time} {who}{name}‡πÄ‡∏≠‡∏á‡∏Ñ‡∏£‡∏±‡∏ö! ‡∏°‡∏µ‡∏≠‡∏∞‡πÑ‡∏£‡πÉ‡∏´‡πâ‡∏ä‡πà‡∏ß‡∏¢‡∏Å‡πá‡∏ß‡πà‡∏≤‡∏°‡∏≤‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢ ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡πâ‡∏≠‡∏°‡∏Ñ‡πâ‡∏≠‡∏°‡∏ô‡∏∞ ‡∏ú‡∏°‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏•‡∏∏‡∏¢!"
    # ‡∏õ‡∏£‡∏±‡∏ö‡πÇ‡∏ó‡∏ô‡∏î‡πâ‡∏ß‡∏¢‡∏Å‡∏ï‡∏¥‡∏Å‡∏≤‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ö adjust_bot_tone (‡∏Å‡∏±‡∏ô‡∏Å‡∏£‡∏ì‡∏µ‡∏°‡∏µ‡∏Ñ‡∏≥‡∏•‡∏á‡∏ó‡πâ‡∏≤‡∏¢‡∏≠‡∏∑‡πà‡∏ô)
    return adjust_bot_tone(base)

def adjust_bot_tone(text: str) -> str:
    """
    ‡∏õ‡∏£‡∏±‡∏ö‡πÇ‡∏ó‡∏ô‡∏Å‡∏≤‡∏£‡∏û‡∏π‡∏î‡∏Ç‡∏≠‡∏á‡∏ö‡∏≠‡∏ó‡πÉ‡∏´‡πâ‡∏™‡∏≠‡∏î‡∏Ñ‡∏•‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ö‡∏ö‡∏∏‡∏Ñ‡∏•‡∏¥‡∏Å '‡∏ä‡∏¥‡∏ö‡∏∞‡∏ô‡πâ‡∏≠‡∏¢'
    - ‡πÅ‡∏ó‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á‡∏ß‡πà‡∏≤ '‡∏ä‡∏¥‡∏ö‡∏∞‡∏ô‡πâ‡∏≠‡∏¢'
    - ‡∏õ‡∏£‡∏±‡∏ö‡∏Ñ‡∏≥‡∏•‡∏á‡∏ó‡πâ‡∏≤‡∏¢‡πÉ‡∏´‡πâ‡∏™‡∏∏‡∏†‡∏≤‡∏û‡πÅ‡∏ö‡∏ö‡∏Å‡∏±‡∏ô‡πÄ‡∏≠‡∏á
    - ‡πÄ‡∏ï‡∏¥‡∏° '‡∏Ñ‡∏£‡∏±‡∏ö' ‡πÉ‡∏´‡πâ‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°
    - ‡πÑ‡∏°‡πà‡πÅ‡∏ï‡∏∞‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡πÇ‡∏Ñ‡πâ‡∏î/‡∏•‡∏¥‡∏á‡∏Å‡πå/inline code
    """
    if not text:
        return ""

    # 0) ‡πÄ‡∏Å‡πá‡∏ö‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡πà‡∏≠‡∏ô
    work, protected = _extract_protected(text)

    # 1) ‡πÅ‡∏ó‡∏ô‡∏™‡∏£‡∏£‡∏û‡∏ô‡∏≤‡∏°
    work = _PRONOUN_RE.sub("‡∏ä‡∏¥‡∏ö‡∏∞‡∏ô‡πâ‡∏≠‡∏¢", work)

    # 2) normalize ‡∏Ñ‡∏≥‡∏•‡∏á‡∏ó‡πâ‡∏≤‡∏¢‡∏™‡∏∏‡∏†‡∏≤‡∏û
    work = _normalize_particles(work)

    # 3) ‡πÄ‡∏ï‡∏¥‡∏° '‡∏Ñ‡∏£‡∏±‡∏ö' ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏ò‡∏£‡∏£‡∏°‡∏ä‡∏≤‡∏ï‡∏¥ (‡∏ó‡∏µ‡∏•‡∏∞‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î)
    work = _append_polite(work, polite=_POLITE_DEFAULT)

    # 4) ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤ protected ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏Ñ‡∏ß‡∏£‡πÅ‡∏ï‡∏∞
    work = _restore_protected(work, protected)

    # 5) ‡πÄ‡∏Å‡πá‡∏ö‡∏Å‡∏ß‡∏≤‡∏î‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á‡∏ã‡πâ‡∏≥‡∏ã‡πâ‡∏≠‡∏ô‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢
    work = re.sub(r"[ \t]+(\n)", r"\1", work)  # ‡πÄ‡∏ß‡πâ‡∏ô‡∏ß‡∏£‡∏£‡∏Ñ‡∏Å‡πà‡∏≠‡∏ô‡∏Ç‡∏∂‡πâ‡∏ô‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÉ‡∏´‡∏°‡πà
    work = re.sub(r"[ ]{2,}", " ", work)       # ‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏Å‡∏¥‡∏ô 1 ‡∏ï‡∏±‡∏ß

    return work

def apply_persona(text: str, add_emoji: bool = False) -> str:
    """
    High-level helper:
    - ‡∏õ‡∏£‡∏±‡∏ö‡πÇ‡∏ó‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏ä‡∏¥‡∏ö‡∏∞‡∏ô‡πâ‡∏≠‡∏¢
    - (‡∏≠‡∏≠‡∏õ‡∏ä‡∏±‡∏ô) ‡πÉ‡∏™‡πà‡∏≠‡∏µ‡πÇ‡∏°‡∏à‡∏¥‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢‡πÉ‡∏´‡πâ‡∏î‡∏π‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏±‡∏ô‡πÄ‡∏≠‡∏á ‡πÅ‡∏ï‡πà‡∏à‡∏∞‡πÑ‡∏°‡πà‡πÄ‡∏¢‡∏≠‡∏∞‡∏à‡∏ô‡∏£‡∏Å
    """
    s = adjust_bot_tone(text)
    if not add_emoji:
        return s

    # ‡πÉ‡∏™‡πà‡πÅ‡∏ö‡∏ö‡∏™‡∏∏‡πà‡∏°‡∏ô‡∏¥‡∏î ‡πÜ ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ó‡πâ‡∏≤‡∏¢‡∏¢‡πà‡∏≠‡∏´‡∏ô‡πâ‡∏≤ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡∏£‡∏ö‡∏Å‡∏ß‡∏ô‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤
    tails = ["üêï", "üí™", "‚úÖ", "üöÄ"]
    # ‡πÅ‡∏ó‡∏£‡∏Å‡∏ó‡∏µ‡πà‡∏ó‡πâ‡∏≤‡∏¢‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏•‡∏±‡∏Å‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏≠‡∏µ‡πÇ‡∏°‡∏à‡∏¥‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß
    if not re.search(r"[üêïüí™‚úÖüöÄ]$", s):
        s = f"{s} {random.choice(tails)}"
    return s
